
- :export:
    inject:
      properties-content: '{* string}'

- :on-os-arch:
    conditional-step:
      condition-kind: regex-match
      label: $os-arch
      regex: '{spec string}'
      steps: '{do list}'

- :on-windows:
    .on-os-arch:
      spec: windows-.*
      do: '{* list}'

- :on-unix:
    .on-os-arch:
      spec: (linux|osx)-.*
      do: '{* list}'

- :shell:
    .on-unix: [ shell: '{* string}' ]

- :batch:
    .on-windows: [ batch: '{* string}' ]

- :go-job:
    job:
      name: '{name string}-go-multiplatform'
      project-type: matrix
      workspace: '/{name}/$os-$arch/src/${git.host string}/${git.user string}/${git.name string}'
      child-workspace: .
      scm:
        - git:
            url: 'git@{git.host string}'
          credentials-id: '{git.credentials string}'
          branches:
            - '**'
          refspec: 'refs/heads/*:refs/remotes/origin/* +refs/tags/*:refs/tags/*'
      triggers:
        - github
      builders:
        - .export: |
            GOPATH=$WORKSPACE/../../../..
            GOARCH=$arch
            BUTLER_LDFLAGS=-X main.version=travis-head
            CGO_ENABLED=1
            CC_FOR_TARGET=gcc
            CXX_FOR_TARGET=g++
        - .on-os-arch:
            spec: windows-386
            do: [ .export: 'Path=$Path;C:\msys64\mingw32\bin' ]
        - .on-os-arch:
            spec: windows-amd64
            do: [ .export: 'Path=$Path;C:\msys64\mingw64\bin' ]
        - .on-unix:
            - .export: PATH=PATH:/usr/local/go/bin
        - .shell: |
            go get -d -v ./...
            go build -v -x -ldflags "$BUTLER_LDFLAGS" {pkg}
            file {name}
            butler -V
        - .batch: |
            go get -d -v ./...
            go build -v -x -ldflags "%BUTLER_LDFLAGS%" {pkg}
            file {name}
            butler -V

- .go-job:
    name: 'butler'
    pkg: './cmd/butler'
    git:
      host: github.com
      user: itchio
      name: butler
      credentials: f5387502-f743-45da-b8d7-1a8bf7d2a54e
